---
title: "Survival extrapolation - Supplementary Appendix"
author: "NCPE"
date: "October 2024"
geometry: margin=2cm
output: pdf_document
---

```{r setup, include=FALSE}

# 20240214 DMC: set maximum of tseq2 to be lifetime horizon (100 years in this case)
## Need to update corresponding code for expertsurv
# Need to edit plots to show maximum time of 15 years.

#library(survHE)
# library(expertsurv)
library(tidyverse)
library(flexsurv)
# Extra packages for plotting
library(GGally)
library(ggpubr)
# Uncomment to install from github:
#devtools::install_github("psyteachr/introdataviz")
#library(introdataviz)
# Format code chunks nicely
library(formatR)

knitr::opts_chunk$set(echo = FALSE,
                      message= FALSE, 
                      warning=FALSE, 
                      cache=TRUE,
                      tidy=TRUE,
                      dev = 'png',
                      tidy.opts=list(width.cutoff=60)
                      )

# Do this next time you run the models
set.seed(12345)

```


```{r run}
# Fit the models etc
source("setup.R")
source("run_all.R")
```



## Importance sampling: model diagnostics, parameter distributions, and survival estimates

We can now examine importance sampling diagnostics, comparisons of likelihood and posterior parameter distributions, and survival time distributions, using the function `expert_surv_viz_gg`.

```{r captions}

captions1<-c(paste0("Importance sampling diagnostics: coefficient of variation (COV) and effective sample size (ESS) as functions of the tempering parameter alpha, ",distributions," distribution. The vertical line shows the optimal value of alpha identified by the algorithm."))
captions2<-c(paste0("Survival curve parameter distributions and covariance estimates obtained using trial data only (MLE) and combining trial data with external information  (IS), ",distributions," distribution"))
captions3<-c(paste0("Survival curves (median and 95% confidence intervals) obtained using trial data only (MLE) and combining trial data with external information (IS), ",distributions," distribution"))

captions<-character(0)

for (i in 0:5){
  
  j<-1+3*i
  
  captions[j]<-captions1[i+1]
  captions[j+1]<-captions2[i+1]
  captions[j+2]<-captions3[i+1]
  
}

```


```{r plotsonly, results='hide', error=FALSE, message=FALSE, warning=FALSE,cache=T}

for (dist in dists)
{
if(!file.exists(paste0("./output/plots_",dist))){
  plots<-is_surv_viz_gg(is.models[[dist]],tseq2,tstar,what=1:3,dist=dist)
  saveRDS(plots,file=paste0("./output/plots_",dist))} else
{
    plots<-readRDS(paste0("./output/plots_",dist))
  }
for ( i in 1:3)
{
ggsave(file=paste0("./output/",dist,"_",i,".png"),plot=plots[[i]])
}
}

```


```{r allplots, results='asis',fig.cap=captions, dpi=300}

for (dist in dists)
{
  print(knitr::kable(is.models[[dist]][["orig"]]$coefficients,caption=paste0("Parameter estimates obtained via MLE: ",distributions[dist])))
  
  cat('\n\n') 
  
  print(knitr::kable(is.models[[dist]][["orig"]]$cov,caption=paste0("Covariance matrix obtained via MLE: ",distributions[dist])))
  
  cat('\n\n') 

  print(knitr::kable(is.models[[dist]]$post_mean,caption=paste0("Parameter estimates obtained via Importance Sampling: ",distributions[dist])))
  
  cat('\n\n') 
  
  print(knitr::kable(is.models[[dist]]$post_cov,caption=paste0("Covariance matrix obtained via Importance Sampling: ",distributions[dist])))
  

  #plots<-is_surv_viz_gg(is.models[[dist]],tseq2,tstar,what=1:3,dist=dist)
  
  plots<-readRDS(paste0("./output/plots_",dist))
  
  print(plots[[1]])
  
  cat('\n\n') 
  
  print(plots[[2]])
  
  cat('\n\n') 
  
  print(plots[[3]])
  
  cat('\n\n') 
}



```



```{r}
knitr::knit_exit()
```

## Parameter variability

The table below shows 'Generalised variance,' i.e., determinants of variance-covariance matrices, of the parameter estimates obtained using trial data only (MLE) and combining trial data withe external information (IS). Formally, the generalised variance gives the area of the 95% highest density ellipse and can be interpreted as a 1-parameter measure of parameter uncertainty, see e.g., https://stats.stackexchange.com/questions/12762/measure-of-spread-of-a-multivariate-normal-distribution .



```{r param_effects,results='asis'}

param.uncertainty<-data.frame("Distribution"=dists,"Distance"=rep(NA,6),"MLE Variance"=rep(NA,6),"IS Variance"=rep(NA,6),"Ratio"=rep(NA,6))

for (i in seq_along(dists))
{
  param.uncertainty[i,2]<-sqrt(sum((is.models[[dists[i]]][["orig"]]$coefficients-is.models[[dists[i]]]$post_mean)^2))
  param.uncertainty[i,3]<-det(as.matrix(is.models[[dists[i]]][["orig"]]$cov))
  param.uncertainty[i,4]<-det(as.matrix(is.models[[dists[i]]]$post_cov))
  param.uncertainty[i,5]<-param.uncertainty[i,4]/param.uncertainty[i,3]
  
}

cat('\n\n')

knitr::kable((param.uncertainty),
             caption="Generalised variance of model parameter distributions. Comparison between parameter estimates obtained using trial data only (MLE) and combining trial data with external information (IS).")

```


# Comparison with expertsurv output

```{r morecaptions}
captions4<-paste0("Survival curves (median and 95% confidence intervals) obtained by combining trial data with external information using the importance sampling (IS) and expertsurv methods, ",distributions," distribution")

captions5<-c(paste0("Survival curve parameter distributions and covariance estimates obtainedby combining trial data with external information using the importance sampling (IS) and expertsurv methods, ",distributions," distribution"))

```


## Plots of survival curves over time


Comparisons of survival curves (median and 95% confidence/credible intervals) obtained from the importance sampling method described in the paper, with those obtained from the fully Bayesian approach of Cooney & Whilte implemented in the expertsurv package.


```{r expersurvIS, results='asis',fig.cap=captions4, dpi=300}
source("comp_expertsurv.R")
# By curve type
for(i in 1:6)
{
  g<-ggplot(data=surv.list[[i]],aes(x=time,colour=Method,fill=Method))+
    geom_line(aes(y=S_median),lwd=1)+
    geom_ribbon(aes(ymin=S_lower,ymax=S_upper),alpha=0.1,linetype="dashed")+
    labs(y="S(t)",x="time (t)",title=paste0("Survival - ",distributions[dists[i]]))
  
  cat('\n\n') 
  print(g)
  cat('\n\n') 
  
}
```

### Comparisons of parameter distributions

Comparisons of survival curve parameter distributions obtained from the importance sampling method described in the paper, with those obtained from the fully Bayesian approach of Cooney & Whilte implemented in the expertsurv package.

```{r plotparams,message=F, warning=F, fig.cap=captions5, dpi=300}

library(GGally)
cat('\n\n') 

for(i in dists){
# Extract parameter draws from the two types of model fit and merge
  df1<-data.frame(is.sims[[i]][["sims.mvn"]],"Method"=rep("IS",5000))
  
  df2<-data.frame(exs.sims[[i]][["sims.mvn"]],"Method"=rep("expertsurv",5000))
  
  names(df2)<-names(df1)
  
  df<-bind_rows(df1,df2)
  
  cat('\n\n') 
  
print(ggpairs(df, aes(colour = Method, alpha = 0.4),
              columns = 1:(ncol(df)-1),
              title=paste0("Parameters - ",distributions[i])))
cat('\n\n') 
}
  
``` 

## Comparisons of AUC distributions

Area under the curve measures mean survival extrapolated over a lifetime (in these examples survival is capped at 100 years since some curves plateau).

```{r AUC,  results='asis', fig.cap="Density plots comparing probabilistic total area under the curve (mean OS) distributions obtained from combining trial data with external information using the importance sampling (IS) method described in the paper, with those obtained from the fully Bayesian method of Cooney & White implemented in the expertsurv package. "}

cat('\n\n') 

#AUC for the models

auc.is<-data.frame(matrix(NA,nrow=5000,ncol=6))
names(auc.is)<-dists
auc.exs<-auc.is


for(dist in dists)
{
  auc.is[dist]<-is.sims[[dist]][["AUC"]]
  auc.exs[dist]<-exs.sims[[dist]][["AUC"]]
}

auc.is["Method"]="IS"
auc.exs["Method"]="expertsurv"

auc.df2<-bind_rows(auc.is,auc.exs) %>%
  pivot_longer(1:6,
               names_to="Distribution",
               values_to="AUC")

auc.summary2<-auc.df2 %>%
  group_by(Distribution,Method) %>%
  summarise(mean=mean(AUC),
            sd=sd(AUC),
            median=median(AUC),
            lwr.95=quantile(AUC,0.025),
            upr.95=quantile(AUC,0.975)) 

# Same for AUC

auc.print2 <- auc.summary2 %>%
  pivot_wider(names_from = Method,values_from = 3:7) %>% 
  mutate(mean_diff=mean_IS-mean_expertsurv,
         var.ratio=sd_IS^2/sd_expertsurv^2,
         Distribution=str_replace_all(Distribution,distributions)) %>% 
  mutate(across(where(is.numeric),~format(round(.x,2),nsmall=2)))  %>%
  mutate(expertsurv=paste0(mean_expertsurv," (",lwr.95_expertsurv,", ",upr.95_expertsurv,")"),
         IS=paste0(mean_IS," (",lwr.95_IS,", ",upr.95_IS,")"),
         Var.Ratio=var.ratio
  ) %>%
  ungroup() %>%
  select(Distribution,expertsurv,IS,Mean.Diff=mean_diff,Var.Ratio) 

knitr::kable(auc.print2,
             caption = "Comparison of probabilistic total area under the curve (mean lifetime OS) estimates, obtained from combining trial data with external information using the importance sampling (IS) method described in the paper, and with the fully Bayesian method of Cooney & White implemented in the expertsurv package. Values shown are probabilstic mean and 95% confidence/credible intervals.")

# AUC density plot
# No truncation of AUC values but truncation of graph
library(ggridges)

cat('\n\n') 

g.auc<-ggplot(data=auc.df2,aes(x=AUC,y=Distribution,colour=Method,fill=Method))+
  geom_density_ridges(alpha=0.5,scale=0.95)+
  scale_fill_manual(values=cbPalette[2:3])+
  scale_colour_manual(values=cbPalette[2:3])+
  labs(x="AUC (Mean lifetime OS, Months)",y="Density")+
  xlim(0,360)+
  theme(legend.position = "bottom")

g.auc

cat('\n\n') 

```




## Comparisons of 5-year OS

Given that the external information concerns OS at 5 years, we compare estimates of 5-year OS obtained from the two methods.


```{r ststar,  results='asis', fig.cap = "Density plots comparing 5-year OS estimates, obtained from combining trial data with external information using the importance sampling (IS) method described in the paper, with those obtained from the fully Bayesian method of Cooney & White implemented in the expertsurv package."}
library(scales)

surv.tstar2<-data.frame()

for (dist in dists)
{
  tmp.df<-data.frame("expertsurv"=unname(exs.sims[[dist]][["s.tstar"]]),
                     "IS"=unname(is.sims[[dist]][["s.tstar"]]),
                     "dist"=dist)
  surv.tstar2<-bind_rows(surv.tstar2,tmp.df)
  rm(tmp.df)
}

surv.tstar.long2<-pivot_longer(surv.tstar2,cols=1:2,values_to = "S.tstar") %>%
  mutate(Output=factor(name,levels=c("IS","expertsurv")),
         Distribution=str_replace_all(dist,distributions))

surv.tstar.summary2<-surv.tstar.long2 %>% 
  group_by(Distribution,Output) %>%
  summarise(mean=mean(S.tstar),
            median=median(S.tstar),
            sd=sd(S.tstar),
            lwr.95=quantile(S.tstar,0.025),
            upr.95=quantile(S.tstar,0.975)) %>%
  ungroup %>%
  mutate(across(where(is.numeric),~percent(.x,accuracy=0.01))) 
cat('\n\n') 

knitr::kable(surv.tstar.summary2,
             caption = "Comparison of 5-year OS estimates, obtained from combining trial data with external information using the importance sampling (IS) method described in the paper, with the fully Bayesian method of Cooney & White implemented in the expertsurv package.")

g.ststar2<-ggplot(data=surv.tstar.long2,aes(x=S.tstar,y=Distribution,colour=Output,fill=Output))+
  geom_density_ridges(alpha=0.5,scale=1)+
  scale_fill_manual(values=cbPalette)+
  scale_colour_manual(values=cbPalette)+
  labs(x="5-year landmark OS",y="Density")

cat('\n\n') 
g.ststar2
cat('\n\n') 
```
